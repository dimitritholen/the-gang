---
allowed-tools: Bash, Read, Glob
argument-hint: [optional: feature-slug]
description: Clean up temporary handoff files from .claude/memory/
---

# Memory Cleanup Utility

Clean up temporary handoff files (.tmp-\*) from `.claude/memory/` directory.

## Purpose

During workflows like `/gather-requirements`, temporary handoff files are created for agent-orchestrator communication. These files are normally auto-deleted after use, but may persist if:

- Workflow was interrupted
- Error occurred during cleanup
- Workflow validation failed

This command helps manually clean up those temporary files.

## Usage

**Clean up specific feature:**

```bash
/cleanup-memory expense-tracking
```

**Clean up all temporary files:**

```bash
/cleanup-memory
```

## Execution

### Step 1: Identify Temporary Files

```bash
echo "Scanning .claude/memory/ for temporary files..."

# List all .tmp-* files
TEMP_FILES=$(ls .claude/memory/.tmp-* 2>/dev/null || echo "")

if [ -z "$TEMP_FILES" ]; then
  echo "✓ No temporary files found - memory is clean"
  exit 0
fi

echo "Found temporary files:"
ls -lh .claude/memory/.tmp-*
echo ""
```

### Step 2: Filter by Feature Slug (if provided)

```bash
FEATURE_SLUG="$ARGUMENTS"

if [ -n "$FEATURE_SLUG" ]; then
  echo "Filtering for feature: $FEATURE_SLUG"

  # Find files matching this feature slug
  MATCHING_FILES=$(ls .claude/memory/.tmp-*${FEATURE_SLUG}* 2>/dev/null || echo "")

  if [ -z "$MATCHING_FILES" ]; then
    echo "✓ No temporary files found for feature: $FEATURE_SLUG"
    exit 0
  fi

  echo "Found files for $FEATURE_SLUG:"
  ls -lh .claude/memory/.tmp-*${FEATURE_SLUG}*
  echo ""
fi
```

### Step 3: Show File Details

```bash
echo "File details:"
echo "============="

if [ -n "$FEATURE_SLUG" ]; then
  # Show specific feature files
  for file in .claude/memory/.tmp-*${FEATURE_SLUG}*; do
    if [ -f "$file" ]; then
      echo "📄 $(basename $file)"
      echo "   Size: $(du -h "$file" | cut -f1)"
      echo "   Modified: $(stat -c %y "$file" 2>/dev/null || stat -f %Sm "$file")"

      # Show first 3 lines to identify content
      echo "   Preview:"
      head -n 3 "$file" | sed 's/^/   | /'
      echo ""
    fi
  done
else
  # Show all temporary files
  for file in .claude/memory/.tmp-*; do
    if [ -f "$file" ]; then
      echo "📄 $(basename $file)"
      echo "   Size: $(du -h "$file" | cut -f1)"
      echo "   Modified: $(stat -c %y "$file" 2>/dev/null || stat -f %Sm "$file")"

      # Show first 3 lines to identify content
      echo "   Preview:"
      head -n 3 "$file" | sed 's/^/   | /'
      echo ""
    fi
  done
fi
```

### Step 4: Confirm Deletion

**Present confirmation to user:**

```
⚠️  Ready to delete temporary files

These files will be permanently deleted:
{List of files to delete}

These files contain:
- Questions generated by agents
- Answers provided during workflows
- Other temporary handoff data

Permanent artifacts (requirements-*.md, etc.) will NOT be deleted.

Do you want to proceed with deletion?
```

**If user confirms:**

### Step 5: Delete Files

```bash
echo "Deleting temporary files..."

DELETED_COUNT=0

if [ -n "$FEATURE_SLUG" ]; then
  # Delete specific feature files
  for file in .claude/memory/.tmp-*${FEATURE_SLUG}*; do
    if [ -f "$file" ]; then
      rm "$file"
      echo "✓ Deleted: $(basename $file)"
      DELETED_COUNT=$((DELETED_COUNT + 1))
    fi
  done
else
  # Delete all temporary files
  for file in .claude/memory/.tmp-*; do
    if [ -f "$file" ]; then
      rm "$file"
      echo "✓ Deleted: $(basename $file)"
      DELETED_COUNT=$((DELETED_COUNT + 1))
    fi
  done
fi

echo ""
echo "✅ Cleanup complete: $DELETED_COUNT file(s) deleted"
```

### Step 6: Verify Cleanup

```bash
# Verify no temporary files remain
REMAINING=$(ls .claude/memory/.tmp-* 2>/dev/null || echo "")

if [ -z "$REMAINING" ]; then
  echo "✓ All temporary files removed"
else
  echo "⚠️  Some temporary files remain:"
  ls -lh .claude/memory/.tmp-*
fi

# Show permanent artifacts that remain
echo ""
echo "Permanent artifacts in memory:"
ls -lh .claude/memory/*.md 2>/dev/null | grep -v ".tmp-" || echo "None"
```

## Safety Features

**Protected Files:**

- Only deletes files matching `.tmp-*` pattern
- Never deletes permanent artifacts (requirements-_.md, tech-analysis-_.md, etc.)
- Shows file preview before deletion
- Requires user confirmation

**Dry Run Mode:**
To preview what would be deleted without actually deleting:

```bash
# Just list the files without running the full command
ls -lh .claude/memory/.tmp-*
```

## Common Scenarios

**After interrupted workflow:**

```bash
# Find and remove leftover handoffs
/cleanup-memory expense-tracking
```

**Bulk cleanup after multiple workflows:**

```bash
# Remove all temporary files
/cleanup-memory
```

**Check what's taking up space:**

```bash
# Before cleanup, inspect
du -h .claude/memory/.tmp-* 2>/dev/null
```

## Exit Codes

- `0`: Success (files deleted or none found)
- `1`: Error during deletion
- `2`: User cancelled deletion

## Notes

- Temporary files are prefixed with `.tmp-` for easy identification
- Hidden files (starting with `.`) won't appear in normal file listings
- Safe to run anytime - won't affect permanent artifacts
- Automatic cleanup happens during normal workflow execution
