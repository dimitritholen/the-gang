---
allowed-tools: Read, Glob, Edit, Write, Bash
argument-hint: [optional: feature-slug]
description: Clean up temporary handoff files from .claude/memory/
---

# Memory Cleanup Utility

Clean up temporary handoff files (.tmp-\*) from `.claude/memory/` directory using a verified, safety-first approach.

## Purpose

During workflows like `/gather-requirements`, temporary handoff files are created for agent-orchestrator communication. These files are normally auto-deleted after use, but may persist if:

- Workflow was interrupted
- Error occurred during cleanup
- Workflow validation failed

This command helps manually clean up those temporary files with built-in safety verification.

## Task Decomposition

This command breaks down the cleanup operation into verifiable sub-tasks to ensure safe, thorough execution.

### Task 1: Scan and Identify

Locate all temporary files in the memory directory.

**Execution:**

Use Glob tool to find temporary files:

- Pattern: `.tmp-*`
- Path: `.claude/memory/`

If no files found, report "No temporary files found - memory is clean" and exit.
If files found, proceed to Task 2.

**Verification checkpoint:**

- Confirm: Are we only looking at .tmp-\* pattern?
- Confirm: Is search limited to .claude/memory/ directory?
- Risk check: Could this accidentally match permanent files?

### Task 2: Filter by Scope

Apply feature-slug filter if specified by user.

**Execution:**

If feature-slug argument provided:

- Use Glob with pattern: `.tmp-*{feature-slug}*`
- Path: `.claude/memory/`
- If no matches, report and exit
- If matches found, proceed

If no feature-slug:

- Use all files from Task 1
- Report: "Scope: All temporary files (no filter)"

**Verification checkpoint:**

- Confirm: Does the filter pattern correctly match feature naming?
- Confirm: Are we providing clear user feedback about scope?
- Edge case check: What if feature-slug contains special characters?

### Task 3: Inspect and Classify

Show detailed file information to confirm deletion targets.

**Execution:**

For each file from Task 2:

1. Use Read tool with limit=3 to preview first 3 lines
2. Use Bash to get file metadata (size, modification time)
3. Display formatted output:
   - File: {basename}
   - Size: {size}
   - Modified: {timestamp}
   - Content preview: {first 3 lines}

**Verification checkpoint:**

- Confirm: Does preview show enough info to verify these are temp files?
- Confirm: Are we handling cross-platform file metadata retrieval?
- Safety check: Are we definitely NOT matching permanent artifacts?

### Task 4: Pre-deletion Verification

Validate deletion safety before proceeding.

**Verification round:**

Check each concern:

1. **Pattern safety**: Are we ONLY matching .tmp-\* pattern?
   - Yes: Pattern is explicit and restrictive
   - No permanent files match this pattern

2. **Scope correctness**: Have we correctly identified the target files?
   - Review the file list from Task 3
   - Confirm all files shown are temporary handoffs
   - Verify no requirements-\*.md or other artifacts listed

3. **User awareness**: Does user understand what will be deleted?
   - Present clear file list
   - Show content previews
   - Explain what these files contain

4. **Reversibility**: Can we recover if something goes wrong?
   - No: Deletion is permanent
   - Action: Require explicit user confirmation

**Present confirmation to user:**

```
Ready to delete temporary files
================================

These files will be permanently deleted:
{List of files from Task 3}

These files typically contain:
- Questions generated by agents
- Answers provided during workflows
- Temporary handoff data between agents

PROTECTED (will NOT be deleted):
- requirements-*.md
- tech-analysis-*.md
- implementation-plan-*.md
- Any other permanent artifacts

Do you want to proceed with deletion? (yes/no)
```

### Task 5: Execute Deletion

Perform verified deletion with progress tracking.

**If user confirms:**

Use Bash to delete files from Task 2 list:

- Execute `rm` command for each file
- Track deletion count (success/failure)
- Report status for each file
- Display summary: "Deleted X file(s), Failed Y file(s)"

**Verification checkpoint:**

- Confirm: Are we tracking both successes and failures?
- Confirm: Are errors being caught and reported?
- Recovery check: Can user retry if some deletions fail?

### Task 6: Post-deletion Validation

Verify cleanup completed successfully.

**Execution:**

1. Re-scan with Glob using same pattern from Task 2
2. If feature-slug provided and no files found:
   - Report: "SUCCESS: All temporary files removed for feature: {feature-slug}"
3. If no feature-slug and no files found:
   - Report: "SUCCESS: All temporary files removed"
4. If files remain:
   - Report: "WARNING: Some files remain" + list files

5. Verify permanent artifacts untouched:
   - Use Glob with pattern: `*.md` in `.claude/memory/`
   - Exclude `.tmp-*` files
   - Display: "Permanent artifacts (protected, still present):"

**Final verification questions:**

1. Did we delete ONLY temporary files?
   - Check: No permanent artifacts in deletion list
   - Check: Permanent artifacts still present in validation

2. Did we handle all edge cases?
   - Empty directory
   - Permission errors
   - Feature-slug with no matches

3. Is the user clearly informed of results?
   - Success/failure counts
   - Remaining files (if any)
   - Confirmation of protected files

4. Could this command be run safely again?
   - Yes: Idempotent operation
   - Re-running on clean directory safely reports "no files found"

## Safety Features

**Pattern Protection:**

- ONLY deletes files matching `.tmp-*` pattern
- Pattern is explicit, not glob-based matching of permanent files

**Scope Validation:**

- Shows file previews before deletion
- Requires explicit user confirmation
- Tracks and reports failures

**Protected Files:**

- Never matches requirements-\*.md
- Never matches tech-analysis-\*.md
- Never matches implementation-plan-\*.md
- Only targets temporary handoff files

**Error Handling:**

- Catches deletion failures
- Reports partial success
- Allows retry after investigation

## Usage Examples

**Clean specific feature:**

```bash
/cleanup-memory expense-tracking
```

**Clean all temporary files:**

```bash
/cleanup-memory
```

**Dry run (preview only):**

Use Glob to list files: pattern `.tmp-*`, path `.claude/memory/`

## Exit Codes

- `0`: Success (files deleted or none found)
- `1`: Error during deletion (partial failure possible)
- `2`: User cancelled deletion

## Common Scenarios

**After interrupted workflow:**
Files remain from incomplete agent orchestration - cleanup specific feature.

**Bulk cleanup after multiple workflows:**
Multiple features tested, clean all temporary artifacts at once.

**Pre-deployment cleanup:**
Ensure no temporary files committed to version control.

## Notes

- Temporary files prefixed with `.tmp-` for identification
- Hidden files (starting with `.`) don't appear in normal listings
- Safe to run anytime - idempotent operation
- Automatic cleanup normally happens during workflow execution
- Manual cleanup needed only for interrupted/failed workflows
